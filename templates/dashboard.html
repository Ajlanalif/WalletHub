{% extends "base.html" %}
{% block title %} Dashboard {% endblock %}
{% block link %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
{% endblock %}
{% block content %}

<div class="master">
    <div class="form-container">
            <div class="dashboard-header">
        <div class="user-greeting">
            Hello, {{ user_details.last_name }}!
        </div>
    </div>
    <div class="dashboard-center">

        <div class="budget-tab" id="budgetTab">
        <div class="budget-header" onclick="toggleBudgetDetails()">
            <h2>Your Budget - {{ month_name }} {{ current_year }}</h2>
            <div class="budget-toggle-icon" id="budgetToggleIcon">
                <i class="fas fa-chevron-down"></i>
            </div>
        </div>
            
        <div class="budget-summary">
            <div class="budget-values">
                <span class="budget-label">Budget:</span>
                {% if budget %}
                    <span class="budget-amount">{{ "%.2f"|format(budget) }}/=</span>
                {% else %}
                    <span class="budget-amount no-budget">Not Set</span>
                    <button onclick="showBudgetModal()" class="set-budget-btn">Set Budget</button>
                {% endif %}            
            </div>
        </div>

        {% if budget %}
<div class="budget-details" id="budgetDetails">
    <div class="budget-values">
        <span class="budget-label">Monthly Expenses:</span>
        {% set percent = (total_monthly_expenses / budget * 100) if budget else 0 %}
        <span class="expense-amount
            {% if percent < 50 %}
                green
            {% elif percent < 80 %}
                yellow  
            {% else %}
                red
            {% endif %}
        ">
            {{ "%.2f"|format(total_monthly_expenses) }}/=
        </span>
    </div>
    
    <div class="budget-values">
        <span class="budget-label">Remaining Balance:</span>
        <span class="remaining-amount
            {% if percent < 50 %}
                green
            {% elif percent < 80 %}
                yellow  
            {% else %}
                red
            {% endif %}
        ">
            {{ "%.2f"|format(budget-total_monthly_expenses) }}/=
        </span>
    </div>
    
    <div class="budget-progress">
        <div class="progress-bar">
            <div class="progress-fill 
                {% if percent < 50 %}
                    green
                {% elif percent < 80 %}
                    yellow
                {% else %}
                    red
                {% endif %}
            " style="width: {{ [percent, 100]|min }}%"></div>
        </div>
        <small class="progress-text">{{ "%.1f"|format(percent) }}% of budget used</small>
    </div>
    
    <div class="budget-actions">
        <button onclick="showBudgetModal()" class="edit-budget-btn">Edit Budget</button>
    </div>
</div>
{% endif %}
    </div>
</div>
        <!-- Balance Tiles -->
        <div class="balance-container">
            <!-- Loan Tile - Only shows if user has active loans -->
            {% if active_loans %}
            <a href="{{ url_for('loans') }}" class="balance-tile-link">
                <div class="balance-tile loan">
                    <h3>Active Loans</h3>
                    <p><strong>Total:</strong> {{ active_loans_amount }}/=</p>
                    <p class="tile-hint">{{ active_loans|length }} loan(s) active</p>
                    {% if due_soon_loans %}
                    <div class="loan-due-badge">{{ due_soon_loans|length }} due soon</div>
                    {% endif %}
                </div>
            </a>
            {% endif %}

             <!-- Receivable Tile - Only shows if user has active receivables -->
            {% if active_receivables %}
            <a href="{{ url_for('receivables') }}" class="balance-tile-link">
                <div class="balance-tile receivable">
                    <h3>Money Owed to You</h3>
                    <p><strong>Total:</strong> {{ active_receivables_amount }}/=</p>
                    <p class="tile-hint">{{ active_receivables|length }} receivable(s) active</p>
                    {% if due_soon_receivables %}
                    <div class="receivable-due-badge">{{ due_soon_receivables|length }} due soon</div>
                    {% endif %}
                </div>
            </a>
            {% endif %}


            <a href="{{ url_for('bank_transactions') }}" class="balance-tile-link">
                <div class="balance-tile bank">
                    <h3>Bank Balance</h3>
                    <p><strong>Total:</strong> {{ bank_balance }}/=</p>
                    <p class="tile-hint">Click to view bank transactions</p>
                </div>
            </a>

            <a href="{{ url_for('mfs_transactions') }}" class="balance-tile-link">
                <div class="balance-tile mfs">
                    <h3>Mobile Banking Balance</h3>
                    <p><strong>Total:</strong> {{ mfs_balance }}/=</p>
                    <p class="tile-hint">Click to view mobile banking transactions</p>
                </div>
            </a>

            <a href="{{ url_for('wallet_transactions') }}" class="balance-tile-link">
                <div class="balance-tile wallet">
                    <h3>Cash Balance</h3>
                    <p><strong>Total:</strong> {{ wallet_balance }}/=</p>
                    <p class="tile-hint">Click to view cash transactions</p>
                </div>
            </a>
        </div>

        <div class="view-all-container">
            <a href="{{ url_for('monthly_tracker') }}" class="view-all-button">
                <i class="fas fa-list"></i> View Transaction Summary of this Month
            </a>
            
        </div>
        <div class="savings-container">
    <a href="{{ url_for('savings') }}" class="savings-button">
        <i class="fas fa-piggy-bank"></i> Manage Savings
    </a>
</div>

        <div class="transaction-container">
            <div class="transaction-buttons">
                <button onclick="showForm('income')" class="tab-button active">Income</button>
                <button onclick="showForm('expense')" class="tab-button">Expense</button>
                <button onclick="showForm('transfer')" class="tab-button">Transfer</button>
            </div>
            <h2>Enter Transaction</h2>

            <!-- Income Form -->
            <div id="income-form" class="transaction-form hidden">
                <h3>Income</h3>
                <form method="POST" action="{{ url_for('income') }}">
                    <input type="hidden" name="transaction_type" value="income">
                    <label for="income_account_type">Account Type:</label>
                    <select id="income_account_type" name="account_type"
                        onchange="toggleFields('income_account_type','income_bank_fields','income_mfs_fields')"
                        required>
                        <option value="">Select Account Type</option>
                        <option value="wallet">Cash</option>
                        <option value="bank">Bank</option>
                        <option value="mfs"> Mobile Banking Service</option>
                    </select><br><br>

                    <div id="income_bank_fields" class="hidden">
                        <label>Bank Name:</label>
                        <select name="bank_name">
                            {% for bank in bank_accounts %}
                            <option value="{{ bank.bank_name }}">{{ bank.bank_name }}</option>
                            {% endfor %}
                        </select><br><br>

                        <label>Account No:</label>
                        <select name="bank_acc_no">
                            {% for bank in bank_accounts %}
                            <option value="{{ bank.account_number }}">{{ bank.account_number }}</option>
                            {% endfor %}
                        </select><br><br>
                    </div>

                    <div id="income_mfs_fields" class="hidden">
                        <label>  Mobile Banking Service Name:</label>
                        <select name="mfs_name">
                            {% for mfs in mfs_accounts %}
                            <option value="{{ mfs.mfs_name }}">{{ mfs.mfs_name }}</option>
                            {% endfor %}
                        </select><br><br>

                        <label>Account No:</label>
                        <select name="mfs_acc_no">
                            {% for mfs in mfs_accounts %}
                            <option value="{{ mfs.account_no }}">{{ mfs.account_no }}</option>
                            {% endfor %}
                        </select><br><br>
                    </div>
                    <label for="description">Income Source:</label>
                    <input type="text" list="income-source-options" id="description" name="description"
                        placeholder="Type to search sources..." required>
                    <datalist id="income-source-options">
                        <option value="Salary">Salary</option>
                        <option value="Freelance Work">Freelance Work</option>
                        <option value="Business Income">Business Income</option>
                        <option value="Investments">Investments</option>
                        <option value="Dividends">Dividends</option>
                        <option value="Rental Income">Rental Income</option>
                        <option value="Interest">Interest</option>
                        <option value="Royalties">Royalties</option>
                        <option value="Commission">Commission</option>
                        <option value="Bonus">Bonus</option>
                        <option value="Gifts">Gifts</option>
                        <option value="Tax Refund">Tax Refund</option>
                        <option value="Social Security">Social Security</option>
                        <option value="Pension">Pension</option>
                        <option value="Alimony">Alimony</option>
                        <option value="Child Support">Child Support</option>
                        <option value="Lottery/Gambling">Lottery/Gambling</option>
                        <option value="Other">Other</option>
                    </datalist><br><br>
                    <label for="income_amount">Amount:</label>
                    <input type="number" id="income_amount" name="amount" step="0.01" required><br><br>

                    <label for="income_date">Date:</label>
                    <input type="date" id="income_date" name="date" value="{{ today_date }}" required><br><br>

                    <button type="submit">Submit Income</button>
                </form>

            </div>

            <!-- Expense Form -->
            <div id="expense-form" class="transaction-form">
                <h3>Expense</h3>
                <form method="POST" action="{{ url_for('expense') }}">
                    <input type="hidden" name="transaction_type" value="expense">
                    <label for="expense_account_type">Account Type:</label>
                    <select id="expense_account_type" name="account_type"
                        onchange="toggleFields('expense_account_type','expense_bank_fields','expense_mfs_fields')"
                        required>
                        <option value="">Select Account Type</option>
                        <option value="wallet">Cash</option>
                        <option value="bank">Bank</option>
                        <option value="mfs">  Mobile Banking Service</option>
                    </select><br><br>

                    <div id="expense_bank_fields" class="hidden">
                        <label>Bank Name:</label>
                        <select name="bank_name">
                            {% for bank in bank_accounts %}
                            <option value="{{ bank.bank_name }}">{{ bank.bank_name }}</option>
                            {% endfor %}
                        </select><br><br>

                        <label>Account No:</label>
                        <select name="bank_acc_no">
                            {% for bank in bank_accounts %}
                            <option value="{{ bank.account_number }}">{{ bank.account_number }}</option>
                            {% endfor %}
                        </select><br><br>
                    </div>

                    <div id="expense_mfs_fields" class="hidden">
                        <label> Mobile Banking Service Name:</label>
                        <select name="mfs_name">
                            {% for mfs in mfs_accounts %}
                            <option value="{{ mfs.mfs_name }}">{{ mfs.mfs_name }}</option>
                            {% endfor %}
                        </select><br><br>

                        <label>Account No:</label>
                        <select name="mfs_acc_no">
                            {% for mfs in mfs_accounts %}
                            <option value="{{ mfs.account_no }}">{{ mfs.account_no }}</option>
                            {% endfor %}
                        </select><br><br>
                    </div>



                    <label for="expense_amount">Amount:</label>
                    <input type="number" id="expense_amount" name="amount" step="0.01" required><br><br>

                    <!-- REPLACED SELECT WITH INPUT+DATALIST -->
                    <label for="expense_category">Category:</label>
                    <input type="text" list="category-options" id="expense_category" name="category"
                        placeholder="Type to search categories..." required>
                    <datalist id="category-options">
                        <option value="Housing">Housing</option>
                        <option value="Groceries">Groceries</option>
                        <option value="Transportation">Transportation</option>
                        <option value="Healthcare">Healthcare</option>
                        <option value="Education">Education</option>
                        <option value="Communication">Communication</option>
                        <option value="Debt Repayment">Debt Repayment</option>
                        <option value="Entertainment">Entertainment</option>
                        <option value="Dining Out">Dining Out</option>
                        <option value="Travel & Vacation">Travel & Vacation</option>
                        <option value="Shopping">Shopping</option>
                        <option value="Hobbies & Leisure">Hobbies & Leisure</option>
                        <option value="Savings">Savings</option>
                        <option value="Investments">Investments</option>
                        <option value="Retirement Planning">Retirement Planning</option>
                        <option value="Balance Transfers">Balance Transfers</option>
                        <option value="Loans & Repayments">Loans & Repayments</option>
                        <option value="Gifts & Donations">Gifts & Donations</option>
                        <option value="Childcare & Education">Childcare & Education</option>
                        <option value="Pet Care">Pet Care</option>
                        <option value="Bank & Service Fees">Bank & Service Fees</option>
                        <option value="Subscriptions">Subscriptions</option>
                        <option value="Fines & Penalties">Fines & Penalties</option>
                        <option value="Personal Care">Personal Care</option>
                        <option value="Medicine">Medicine</option>
                    </datalist><br><br>

                    <label for="expense_date">Date:</label>
                    <input type="date" id="expense_date" name="date" value="{{ today_date }}" required><br><br>

                    <button type="submit">Submit Expense</button>
                </form>
            </div>

            <!-- Transfer Form -->
            <div id="transfer-form" class="transaction-form hidden">
                <h3>Transfer</h3>
                <form method="POST" action="{{ url_for('transfer') }}">
                    <input type="hidden" name="transaction_type" value="transfer">

                    <!-- Sender Section -->
                    <h4>From (Sender)</h4>
                    <label for="sender_account_type">Account Type:</label>
                    <select id="sender_account_type" name="sender_account_type"
                        onchange="toggleFields('sender_account_type','sender_bank_fields','sender_mfs_fields')"
                        required>
                        <option value="">Select Account Type</option>
                        <option value="wallet">Cash</option>
                        <option value="bank">Bank</option>
                        <option value="mfs"> Mobile Banking Service</option>
                    </select><br><br>

                    <div id="sender_bank_fields" class="hidden">
                        <label>Bank Name:</label>
                        <select name="sender_bank_name">
                            {% for bank in bank_accounts %}
                            <option value="{{ bank.bank_name }}">{{ bank.bank_name }}</option>
                            {% endfor %}
                        </select><br><br>

                        <label>Account No:</label>
                        <select name="sender_bank_acc_no">
                            {% for bank in bank_accounts %}
                            <option value="{{ bank.account_number }}">{{ bank.account_number }}</option>
                            {% endfor %}
                        </select><br><br>
                    </div>

                    <div id="sender_mfs_fields" class="hidden">
                        <label> Mobile Banking Service Name:</label>
                        <select name="sender_mfs_name">
                            {% for mfs in mfs_accounts %}
                            <option value="{{ mfs.mfs_name }}">{{ mfs.mfs_name }}</option>
                            {% endfor %}
                        </select><br><br>

                        <label>Account No:</label>
                        <select name="sender_mfs_acc_no">
                            {% for mfs in mfs_accounts %}
                            <option value="{{ mfs.account_no }}">{{ mfs.account_no }}</option>
                            {% endfor %}
                        </select><br><br>
                    </div>

                    <!-- Receiver Section -->
                    <h4>To (Receiver)</h4>
                    <label for="receiver_account_type">Account Type:</label>
                    <select id="receiver_account_type" name="receiver_account_type"
                        onchange="toggleFields('receiver_account_type','receiver_bank_fields','receiver_mfs_fields')"
                        required>
                        <option value="">Select Account Type</option>
                        <option value="wallet">Cash</option>
                        <option value="bank">Bank</option>
                        <option value="mfs"> Mobile Banking Service</option>
                    </select><br><br>

                    <div id="receiver_bank_fields" class="hidden">
                        <label>Bank Name:</label>
                        <select name="receiver_bank_name">
                            {% for bank in bank_accounts %}
                            <option value="{{ bank.bank_name }}">{{ bank.bank_name }}</option>
                            {% endfor %}
                        </select><br><br>

                        <label>Account No:</label>
                        <select name="receiver_bank_acc_no">
                            {% for bank in bank_accounts %}
                            <option value="{{ bank.account_number }}">{{ bank.account_number }}</option>
                            {% endfor %}
                        </select><br><br>
                    </div>

                    <div id="receiver_mfs_fields" class="hidden">
                        <label> Mobile Banking Service Name:</label>
                        <select name="receiver_mfs_name">
                            {% for mfs in mfs_accounts %}
                            <option value="{{ mfs.mfs_name }}">{{ mfs.mfs_name }}</option>
                            {% endfor %}
                        </select><br><br>

                        <label>Account No:</label>
                        <select name="receiver_mfs_acc_no">
                            {% for mfs in mfs_accounts %}
                            <option value="{{ mfs.account_no }}">{{ mfs.account_no }}</option>
                            {% endfor %}
                        </select><br><br>
                    </div>

                    <label for="transfer_amount">Amount:</label>
                    <input type="number" id="transfer_amount" name="amount" step="0.01" required><br><br>

                    <label for="transfer_date">Date:</label>
                    <input type="date" id="transfer_date" name="date" value="{{ today_date }}" required><br><br>

                    <button type="submit">Submit Transfer</button>
                </form>
            </div>
        </div>
    </div>
    <!-- Insufficient Funds / Loan Modal -->
    <div id="loanModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Insufficient Funds</h3>
                <span class="close-modal" id="loanModalClose">&times;</span>
            </div>
            <div class="modal-body">
                <p>You don't have enough balance in the selected account.</p>
                <p>Would you like to record this as a loan?</p>

                <form id="loanForm" method="POST" action="{{ url_for('create_loan_for_expense') }}">
                    <input type="hidden" name="expense_account_type" id="loan_expense_account_type">
                    <input type="hidden" name="bank_name" id="loan_bank_name">
                    <input type="hidden" name="bank_acc_no" id="loan_bank_acc_no">
                    <input type="hidden" name="mfs_name" id="loan_mfs_name">
                    <input type="hidden" name="mfs_acc_no" id="loan_mfs_acc_no">
                    <input type="hidden" name="expense_amount" id="loan_expense_amount">
                    <input type="hidden" name="expense_category" id="loan_expense_category">
                    <input type="hidden" name="expense_date" id="loan_expense_date">
                    <input type="hidden" name="expense_description" id="loan_expense_description">

                    <div class="form-group">
                        <label for="lender_name">Lender Name:</label>
                        <input type="text" id="lender_name" name="lender_name" required>
                    </div>

                    <div class="form-group">
                        <label for="loan_amount">Loan Amount:</label>
                        <input type="number" id="loan_amount" name="loan_amount" step="0.01" required>
                        <small>Must be equal to or greater than the expense amount.</small>
                    </div>

                    <div class="form-group">
                        <label for="return_date">Return Date:</label>
                        <input type="date" id="return_date" name="return_date" required>
                    </div>

                    <div class="form-group">
                        <label for="loan_notes">Notes:</label>
                        <textarea id="loan_notes" name="loan_notes"></textarea>
                    </div>

                    <div class="form-actions">
                        <button type="button" id="cancelLoanButton" class="cancel-button">Cancel</button>
                        <button type="submit" class="submit-button">Take Loan & Complete Expense</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Receivable Modal -->
<div id="receivableModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Record as Receivable</h3>
            <span class="close-modal" id="receivableModalClose">&times;</span>
        </div>
        <div class="modal-body">
            <p>You are recording this expense as money someone owes you.</p>
            <p>Please enter the receivable details below:</p>

            <form id="receivableForm" method="POST" action="{{ url_for('add_receivable') }}">
                <input type="hidden" name="account_type" id="receivable_account_type">
                <input type="hidden" name="bank_name" id="receivable_bank_name">
                <input type="hidden" name="bank_acc_no" id="receivable_bank_acc_no">
                <input type="hidden" name="mfs_name" id="receivable_mfs_name">
                <input type="hidden" name="mfs_acc_no" id="receivable_mfs_acc_no">
                
                <div class="form-group">
                    <label for="debtor_name">Debtor Name:</label>
                    <input type="text" id="debtor_name" name="debtor_name" required>
                </div>

                <div class="form-group">
                    <label for="receivable_amount">Receivable Amount:</label>
                    <input type="number" id="receivable_amount" name="amount" step="0.01" required>
                    <small>This is the amount someone owes you for this expense.</small>
                </div>

                <div class="form-group">
                    <label for="expected_return_date">Expected Return Date:</label>
                    <input type="date" id="expected_return_date" name="expected_return_date" required>
                </div>
                
                <div class="form-group">
                    <label for="date_lent">Date Lent:</label>
                    <input type="date" id="date_lent" name="date_lent" required>
                    <small>The date when you actually lent the money</small>
                </div>
                
                <div class="form-group">
                    <label for="interest_rate">Interest Rate (%):</label>
                    <input type="number" id="interest_rate" name="interest_rate" step="0.01" value="0" min="0">
                    <small>Optional: Interest rate per year</small>
                </div>

                <div class="form-group">
                    <label for="receivable_notes">Notes:</label>
                    <textarea id="receivable_notes" name="notes" placeholder="Additional details about this receivable..."></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" id="cancelReceivableButton" class="cancel-button">Cancel</button>
                    <button type="submit" class="submit-button">Record Receivable</button>
                </div>
            </form>
        </div>
    </div>
</div>
<div id="budgetModal" class="modal budget-required-modal">
    <div class="modal-content">
        <div class="modal-header">
            {% if not budget %}
            <h3>üéØ Set Your Monthly Budget</h3>
            {% else %}
            <h3>Update Monthly Budget</h3>
            {% endif %}
            <span class="close-modal" onclick="closeBudgetModal()">&times;</span>
        </div>
        <div class="modal-body">
            {% if not budget %}
            <div class="welcome-message">
                <p><strong>Welcome to WalletHub!</strong></p>
                <p>To get the most out of your financial tracking, let's set up your monthly budget for {{ month_name }} {{ current_year }}.</p>
                <p>This will help you:</p>
                <ul style="text-align: left; margin: 15px 0;">
                    <li>üìä Track your spending progress</li>
                    <li>‚ö†Ô∏è Get alerts when approaching budget limits</li>
                    <li>üìà Better manage your finances</li>
                </ul>
            </div>
            {% else %}
            <p>Update your budget for {{ month_name }} {{ current_year }}</p>
            {% endif %}
            
            <form id="budgetForm" method="POST" action="{{ url_for('set_budget') }}">
                <input type="hidden" name="month" value="{{ current_month }}">
                <input type="hidden" name="year" value="{{ current_year }}">
                
                <div class="form-group">
                    <label for="budget_amount">Monthly Budget Amount (‡ß≥):</label>
                    <input type="number" id="budget_amount" name="amount" step="0.01" min="1" required
                           placeholder="Enter your monthly budget" 
                           {% if budget %}value="{{ budget }}"{% endif %}>
                    <small>This will help you track your spending for {{ month_name }}</small>
                </div>
                
                <div class="budget-suggestions">
                    <p><strong>Quick suggestions:</strong></p>
                    <div class="suggestion-buttons">
                        <button type="button" onclick="setBudgetAmount(10000)">10,000/=</button>
                        <button type="button" onclick="setBudgetAmount(20000)">20,000/=</button>
                        <button type="button" onclick="setBudgetAmount(30000)">30,000/=</button>
                        <button type="button" onclick="setBudgetAmount(50000)">50,000/=</button>
                        <button type="button" onclick="setBudgetAmount(100000)">1,00,000/=</button>
                    </div>
                </div>
                
                <div class="form-actions">
                    {% if not budget %}
                    <button type="button" onclick="skipBudget()" class="cancel-button">Skip for Now</button>
                    <button type="submit" class="submit-button primary">Set My Budget</button>
                    {% else %}
                    <button type="button" onclick="closeBudgetModal()" class="cancel-button">Cancel</button>
                    <button type="submit" class="submit-button">Update Budget</button>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Add this after the budget modal, around line 750 -->

<!-- Savings Notifications Modal -->
<div id="savingsNotificationModal" class="modal savings-notification-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-piggy-bank"></i> Savings Reminder</h3>
            <span class="close-modal" onclick="closeSavingsNotification()">&times;</span>
        </div>
        <div class="modal-body" id="savingsNotificationContent">
            <!-- Content will be populated by JavaScript -->
        </div>
    </div>
</div>

<!-- Update Notification Day Modal -->
<div id="updateNotificationModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-calendar-alt"></i> Update Notification Day</h3>
            <span class="close-modal" onclick="closeUpdateNotificationModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="updateNotificationForm">
                <div class="form-group">
                    <label for="new_notification_day">Notification Day (1-28):</label>
                    <input type="number" id="new_notification_day" name="notification_day" 
                           min="1" max="28" required>
                    <small>Choose a day of the month to receive savings reminders</small>
                </div>
                
                <div class="form-actions">
                    <button type="button" onclick="closeUpdateNotificationModal()" class="cancel-button">Cancel</button>
                    <button type="submit" class="submit-button">Update Notification Day</button>
                </div>
            </form>
        </div>
    </div>
</div>
</div>
<script type="text/javascript">
    // This object will be populated by Jinja template
    window.ACCOUNT_DATA = {
        bankAccounts: {},
        mfsAccounts: {}
    };
</script>
<style>
    .master {
        margin: 20px;
        padding: 40px;
        background: radial-gradient(circle, rgba(39, 180, 159, 0.7247899159663865) 0%, rgba(210, 183, 241, 0.8396358543417367) 90%);
        box-shadow: 0px 4px 20px rgba(0, 0, 0, 0.3);
        border-radius: 10px;
        margin-bottom: 40px;
    }

    .balance-container {
        display: flex;
        justify-content: space-between;
        margin-bottom: 30px;
    }

    .balance-tile {
        width: 250px;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        color: white;
        margin: 10px;
    }


    .bank {
        background-color: rgba(0, 123, 255, 0.9);
        box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
        border: 2px solid rgba(0, 123, 255, 1);
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }

    .mfs {
        background-color: #28a745;
        box-shadow: 0 4px 10px rgba(40, 167, 69, 0.3);
        border: 2px solid #218838;
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }

    .wallet {
        background-color: #6f42c1;
        box-shadow: 0 4px 10px rgba(111, 66, 193, 0.3);
        border: 2px solid #5a32a3;
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }

    /* Floating effect on hover */
    .bank:hover,
    .mfs:hover,
    .wallet:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
    }

    .view-all-container {
        display: flex;
        justify-content: center;
        margin-bottom: 30px;
    }

    .view-all-button {
        display: inline-block;
        background-color: #495057;
        color: white;
        padding: 12px 24px;
        border-radius: 5px;
        text-decoration: none;
        font-weight: bold;
        transition: all 0.3s ease;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .view-all-button:hover {
        background-color: #343a40;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .transaction-container {
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
        border: 2px solid black;
        border-radius: 10px;
    }

    .hidden {
        display: none;
    }

    form {
        margin-bottom: 30px;
    }

    select,
    input[type="number"],
    input[type="text"] {
        width: 100%;
        padding: 8px;
        margin: 5px 0;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    button {
        background-color: #007bff;
        color: black;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    button:hover {
        background-color: #0056b3;
    }

    .transaction-buttons {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;

    }

    .tab-button {
        flex: 1;
        margin: 0 5px;
        padding: 10px;
        background-color: #f8f9fa00;
        border: 1px solid black;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .tab-button:hover {
        background-color: #e9ecef;
    }

    .tab-button.active {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }

    .transaction-form {
        background-color: rgba(255, 255, 255, 0);
        padding: 20px;
        border-radius: 4px;

    }

    input,
    select,
    textarea {
        width: 100%;
        padding: 8px;
        margin: 5px 0;
        background-color: transparent;
        border: 1px solid black;
        border-radius: 4px;
    }

    input[type="date"],
    input[type="number"],
    input[type="text"] {
        background-color: transparent;
        border: 1px solid black;
    }

    .form-container h1,
    h2 {
        text-align: center;
    }

    select {
        background-color: transparent !important;
        color: black !important;
        border: 1px solid black !important;
        appearance: auto;
        /* Keep the dropdown arrow visible */
    }

    /* Style for Select2 elements */
    .select2-container--default .select2-selection--single {
        background-color: transparent !important;
        border: 1px solid black !important;
    }

    .select2-container--default .select2-selection--single .select2-selection__rendered {
        background-color: transparent !important;
        color: black !important;
    }

    /* Style for dropdown menu */
    .select2-dropdown {
        background-color: rgba(255, 255, 255, 0.9) !important;
        color: black;
        border: 1px solid black !important;
    }

    /* Style for dropdown items */


    /* Style for dropdown items on hover */
    .select2-container--default .select2-results__option--highlighted[aria-selected] {
        background-color: rgba(0, 123, 255, 0.7) !important;
        color: white !important;
    }

    /* Style for selected dropdown item */
    .select2-container--default .select2-results__option[aria-selected=true] {
        background-color: rgba(0, 0, 0, 0.1) !important;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
    }

    .modal-content {
        position: relative;
        background-color: #fefefe;
        margin: 10% auto;
        padding: 0;
        border: 1px solid #888;
        width: 80%;
        max-width: 600px;
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
        border-radius: 10px;
        animation: modalopen 0.4s;
    }
    .dashboard-header {
    width: 100%;
    display: flex;
    justify-content: flex-end;
    align-items: center;
    margin-bottom: 10px;
}
.user-greeting {
    font-size: 1.2em;
    font-weight: 600;
    color: #333;
    background: #f8f9fa;
    padding: 8px 18px;
    border-radius: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.07);
}

.dashboard-center {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 30px;
}

/* Enhanced Budget Tab Styles */
.budget-tab {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 18px rgba(0,0,0,0.09);
    padding: 20px;
    text-align: center;
    min-width: 320px;
    margin: 0 auto;
    transition: all 0.3s ease;
    cursor: pointer;
}

.budget-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 20px;
    border-radius: 8px;
    transition: background-color 0.3s ease;
    cursor: pointer;
}

.budget-header:hover {
    background-color: rgba(0, 123, 255, 0.05);
}

.budget-header h2 {
    margin: 0;
    color: #007bff;
    font-size: 1.3em;
    flex-grow: 1;
}

.budget-toggle-icon {
    color: #007bff;
    font-size: 1.2em;
    transition: transform 0.3s ease;
    margin-left: 15px;
}

.budget-toggle-icon.rotated {
    transform: rotate(180deg);
}

.budget-summary {
        max-height: 0;
    overflow: hidden;
    opacity: 0;
    transition: max-height 0.4s ease-out, opacity 0.4s ease-out, padding 0.4s ease-out;
    padding: 0 20px;
}
.budget-summary.expanded {
    max-height: 100px;
    opacity: 1;
    padding: 10px 20px;
}

.budget-details {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease-out, padding 0.4s ease-out;
    padding: 0 20px;
}

.budget-details.expanded {
    max-height: 400px;
    padding: 20px;
}

.budget-values {
    margin: 15px 0;
    font-size: 1.1em;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
}

.budget-label {
    font-weight: 500;
    color: #495057;
}

.budget-amount {
    font-weight: 700;
    color: #495057;
}

.expense-amount, .remaining-amount {
    font-weight: 700;
    padding: 4px 12px;
    border-radius: 6px;
    font-size: 1.05em;
    transition: all 0.3s ease;
}

.expense-amount.green, .remaining-amount.green {
    background: #eafaf1;
    color: #28a745;
    border: 1px solid #28a745;
}

.expense-amount.yellow, .remaining-amount.yellow {
    background: #fffbe6;
    color: #ffc107;
    border: 1px solid #ffc107;
}

.expense-amount.red, .remaining-amount.red {
    background: #fdecea;
    color: #dc3545;
    border: 1px solid #dc3545;
}

.no-budget {
    color: #dc3545;
    font-style: italic;
}

.set-budget-btn, .edit-budget-btn {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 0.9em;
    font-weight: 600;
    cursor: pointer;
    margin-left: 10px;
    transition: all 0.3s ease;
}

.set-budget-btn:hover, .edit-budget-btn:hover {
    background: linear-gradient(135deg, #0056b3, #003d82);
    transform: translateY(-1px);
}

.budget-progress {
    margin-top: 20px;
    text-align: left;
}

.progress-bar {
    width: 100%;
    height: 20px;
    background-color: #e9ecef;
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 8px;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
}

.progress-fill {
    height: 100%;
    transition: all 0.3s ease;
    border-radius: 10px;
}

.progress-fill.green {
    background: linear-gradient(90deg, #28a745, #34ce57);
}

.progress-fill.yellow {
    background: linear-gradient(90deg, #ffc107, #ffcd39);
}

.progress-fill.red {
    background: linear-gradient(90deg, #dc3545, #e4606d);
}

.progress-text {
    font-size: 0.85em;
    color: #6c757d;
    font-weight: 500;
    text-align: center;
}

.budget-actions {
    margin-top: 20px;
    text-align: center;
}
/* Budget Modal Styles */
.budget-suggestions {
    margin: 20px 0;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
}

.budget-suggestions p {
    margin-bottom: 10px;
    color: #495057;
    font-size: 0.9em;
}

.suggestion-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.suggestion-buttons button {
    background: #e9ecef;
    border: 1px solid #ced4da;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 0.85em;
    cursor: pointer;
    transition: all 0.2s ease;
}

.suggestion-buttons button:hover {
    background: #007bff;
    color: white;
    border-color: #007bff;
}


    @keyframes modalopen {
        from {
            opacity: 0;
            transform: translateY(-60px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    /* Enhanced Budget Modal for First Time Users */
.budget-required-modal .modal-content {
    border: 3px solid #007bff;
    box-shadow: 0 8px 32px rgba(0,123,255,0.3);
}

.budget-required-modal .modal-header {
    background: linear-gradient(135deg, #007bff, #0056b3);
    padding: 20px;
}

.budget-required-modal .modal-header h3 {
    font-size: 1.4em;
    margin: 0;
}

.welcome-message {
    background: linear-gradient(135deg, #e3f2fd, #f8f9fa);
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    border-left: 4px solid #007bff;
}

.welcome-message p {
    margin: 8px 0;
    color: #333;
}

.welcome-message ul {
    color: #555;
    padding-left: 20px;
}

.welcome-message ul li {
    margin: 5px 0;
    font-size: 0.95em;
}

.submit-button.primary {
    background: linear-gradient(135deg, #28a745, #20c997);
    font-weight: 700;
    padding: 12px 24px;
    font-size: 1.1em;
}

.submit-button.primary:hover {
    background: linear-gradient(135deg, #218838, #1ea080);
    transform: translateY(-1px);
}

    .modal-header {
        padding: 15px;
        background-color: #007bff;
        color: white;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .close-modal {
        color: white;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .modal-body {
        padding: 20px;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
    }

    .cancel-button {
        background-color: #6c757d;
    }

    .submit-button {
        background-color: #28a745;
    }

    .loan {
        background-color: #dc3545;
        box-shadow: 0 4px 10px rgba(220, 53, 69, 0.3);
        border: 2px solid #c82333;
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }

    .loan:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
    }

    .loan-due-badge {
        display: inline-block;
        background-color: #fff;
        color: #dc3545;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: bold;
        margin-top: 5px;
    }
    .receivable {
    background-color: #17a2b8; /* Teal/cyan color for receivables */
    box-shadow: 0 4px 10px rgba(23, 162, 184, 0.3);
    border: 2px solid #138496;
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

.receivable:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
}

.receivable-due-badge {
    display: inline-block;
    background-color: #fff;
    color: #17a2b8;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    font-weight: bold;
    margin-top: 5px;
}
    @media (max-width: 768px) {
    .master {
        margin: 10px;
        padding: 20px;
    }

    /* Balance container - stack tiles vertically on mobile */
    .balance-container {
        flex-direction: column;
        align-items: center;
        justify-content: center; /* Center the tiles vertically */
        width: 100%;
        margin: 0 auto;
        padding: 20px 0;

    }

    .balance-tile {
        width: 100% !important;
        
        margin: 15px 0;
        box-sizing: border-box;
    }

    .balance-tile-link {
        width: 100%;
        display: block;
        text-decoration: none;
    }

    /* Transaction container responsive */
    .transaction-container {
        max-width: 100%;
        padding: 15px;
        margin: 0;
    }

    /* Transaction buttons - stack on mobile */
    .transaction-buttons {
        flex-direction: column;
        gap: 10px;
    }

    .tab-button {
        margin: 5px 0;
        padding: 12px;
        font-size: 16px;
    }

    /* Form elements responsive */
    .transaction-form {
        padding: 15px;
    }

    input, select, textarea {
        font-size: 16px; /* Prevents zoom on iOS */
        padding: 12px;
        margin: 8px 0;
    }

    button {
        font-size: 16px;
        padding: 12px 20px;
        width: 100%;
        margin: 10px 0;
    }

    /* Hidden fields - better spacing */
    .hidden {
        display: none !important;
    }

    /* Form labels */
    label {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 5px;
        display: block;
    }

    .savings-notification-modal .modal-content {
        width: 95%;
        max-width: none;
    }
    
    .notification-scheme {
        padding: 15px;
    }
    
    .notification-scheme-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .notification-actions {
        flex-direction: column;
    }
    
    .notification-btn {
        width: 100%;
        justify-content: center;
        padding: 12px 20px;
    }
    
    .amount-highlight {
        font-size: 1.5em;
    }
    
    .scheme-title {
        font-size: 1.1em;
    }
    /* Headers responsive */
    .form-container h1 {
        font-size: 24px;
        margin-bottom: 15px;
    }

    .form-container h2 {
        font-size: 20px;
        margin-bottom: 20px;
    }

    .transaction-form h3 {
        font-size: 18px;
        margin-bottom: 15px;
    }

    .transaction-form h4 {
        font-size: 16px;
        margin: 15px 0 10px 0;
        color: #495057;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 5px;
    }

    /* View all button responsive */
    .view-all-button {
        width: 100%;
        text-align: center;
        padding: 15px 20px;
        font-size: 16px;
        margin: 20px 0;
    }

    /* Modal responsive */
    .modal-content {
        width: 95%;
        margin: 5% auto;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        padding: 12px 15px;
    }

    .modal-body {
        padding: 15px;
    }

    .form-actions {
        flex-direction: column;
        gap: 10px;
    }

    .form-actions button {
        width: 100%;
        margin: 5px 0;
    }

    /* Loan tile specific */
    .loan-due-badge {
        font-size: 0.75em;
        padding: 2px 6px;
    }

    /* Tile hints */
    .tile-hint {
        font-size: 0.85em;
        margin-top: 5px;
    }

    /* Select2 mobile fixes */
    .select2-container {
        width: 100% !important;
    }

    .select2-container--default .select2-selection--single {
        height: 44px !important;
        padding: 8px !important;
    }

    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 28px !important;
        padding-left: 8px !important;
    }

    .select2-dropdown {
        font-size: 16px;
    }

    /* Datalist input styling for mobile */
    input[list] {
        -webkit-appearance: none;
        appearance: none;
    }
     .master {
        margin: 10px;
        padding: 20px;
    }

    /* Balance container - stack tiles vertically on mobile */
    .balance-container {
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        margin: 0 auto;
        padding: 20px 0;
    }

    .balance-tile {
        width: 100% !important;
        margin: 15px 0;
        box-sizing: border-box;
    }

    .balance-tile-link {
        width: 100%;
        display: block;
        text-decoration: none;
    }

    /* Additional styling for receivable tile on mobile */
    .receivable-due-badge {
        font-size: 0.75em;
        padding: 2px 6px;
    }
}
/* Savings button styling */
.savings-container {
    display: flex;
    justify-content: center;
    margin-bottom: 30px;
}

.savings-button {
    display: inline-block;
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    padding: 15px 30px;
    border-radius: 10px;
    text-decoration: none;
    font-weight: bold;
    font-size: 1.1em;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
}

.savings-button:hover {
    background: linear-gradient(135deg, #218838, #1ea080);
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(40, 167, 69, 0.4);
    color: white;
    text-decoration: none;
}

.savings-button i {
    margin-right: 8px;
    font-size: 1.2em;
}
/* Add this to your existing style section */

/* Savings Notification Modal Styles */
.savings-notification-modal .modal-content {
    border: 3px solid #28a745;
    box-shadow: 0 8px 32px rgba(40, 167, 69, 0.3);
    max-width: 600px;
}

.savings-notification-modal .modal-header {
    background: linear-gradient(135deg, #28a745, #20c997);
    padding: 20px;
}

.savings-notification-modal .modal-header h3 {
    font-size: 1.4em;
    margin: 0;
    color: white;
}

.notification-scheme {
    background: #f8f9fa;
    border: 2px solid #28a745;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    position: relative;
}

.notification-scheme-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.scheme-title {
    font-size: 1.3em;
    font-weight: 700;
    color: #28a745;
    margin: 0;
}

.notification-day-badge {
    background: #007bff;
    color: white;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 0.8em;
    font-weight: 600;
}

.notification-progress {
    margin: 15px 0;
}

.progress-info {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    font-size: 0.9em;
    color: #6c757d;
}

.notification-progress-bar {
    width: 100%;
    height: 12px;
    background: #dee2e6;
    border-radius: 6px;
    overflow: hidden;
}

.notification-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #28a745, #20c997);
    transition: width 0.5s ease;
}

.suggested-amount {
    background: linear-gradient(135deg, #e3f2fd, #f0f8ff);
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #007bff;
    margin: 15px 0;
}

.suggested-amount h4 {
    margin: 0 0 10px 0;
    color: #007bff;
    font-size: 1.1em;
}

.amount-highlight {
    font-size: 1.8em;
    font-weight: 700;
    color: #28a745;
    margin: 10px 0;
}

.notification-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 20px;
}

.notification-btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 0.95em;
}

.notification-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.btn-contribute {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
}

.btn-contribute:hover {
    background: linear-gradient(135deg, #218838, #1ea080);
    color: white;
    text-decoration: none;
}

.btn-change-day {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
}

.btn-change-day:hover {
    background: linear-gradient(135deg, #0056b3, #003d82);
}

.btn-dismiss {
    background: #6c757d;
    color: white;
}

.btn-dismiss:hover {
    background: #495057;
}

.btn-remind-later {
    background: #ffc107;
    color: #212529;
}

.btn-remind-later:hover {
    background: #e0a800;
}

.no-notifications {
    text-align: center;
    padding: 40px 20px;
    color: #6c757d;
}

.no-notifications i {
    font-size: 3em;
    color: #28a745;
    margin-bottom: 20px;
}

/* Update Notification Modal */
.update-notification-form {
    padding: 20px 0;
}
/* Urgency indicator styles */
.urgency-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 10px 0;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.9em;
    font-weight: 600;
}

.urgency-icon {
    font-size: 1.1em;
}

.urgency-message {
    flex-grow: 1;
}

/* Different urgency levels */
.notification-scheme.urgency-today .urgency-indicator {
    background: #e3f2fd;
    color: #1976d2;
    border-left: 4px solid #2196f3;
}

.notification-scheme.urgency-recent .urgency-indicator {
    background: #fff3e0;
    color: #f57c00;
    border-left: 4px solid #ff9800;
}

.notification-scheme.urgency-overdue .urgency-indicator {
    background: #ffeaa7;
    color: #d63031;
    border-left: 4px solid #e17055;
}

.notification-scheme.urgency-critical .urgency-indicator {
    background: #ffecea;
    color: #dc3545;
    border-left: 4px solid #dc3545;
    animation: pulse-urgent 2s infinite;
}

@keyframes pulse-urgent {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}

/* Update notification scheme borders based on urgency */
.notification-scheme.urgency-today {
    border-color: #2196f3;
}

.notification-scheme.urgency-recent {
    border-color: #ff9800;
}

.notification-scheme.urgency-overdue {
    border-color: #e17055;
}

.notification-scheme.urgency-critical {
    border-color: #dc3545;
    box-shadow: 0 0 10px rgba(220, 53, 69, 0.3);
}



/* Small mobile devices */
@media (max-width: 480px) {
    .master {
        margin: 5px;
        padding: 15px;
    }

    .form-container h1 {
        font-size: 20px;
    }

    .form-container h2 {
        font-size: 18px;
    }

    .balance-tile {
        width: 100%;
        padding: 15px;
    }

    .transaction-container {
        padding: 10px;
    }

    .transaction-form {
        padding: 10px;
    }

    .tab-button {
        padding: 10px;
        font-size: 14px;
    }

    input, select, textarea {
        padding: 10px;
        font-size: 16px;
    }

    button {
        padding: 10px 15px;
        font-size: 14px;
    }

    .modal-content {
        width: 98%;
        margin: 2% auto;
    }

    /* Expense form button wrapper */
    .submit-button, .loan-button, .receivable-button  {
        font-size: 14px !important;
        padding: 10px 15px !important;
        margin: 5px 0 !important;
        width: 100% !important;
    }

    /* Form sections spacing */
    .transaction-form h4 {
        font-size: 15px;
        margin: 20px 0 10px 0;
    }
        .progress-info {
        flex-direction: column;
        gap: 5px;
    }
    
    .suggested-amount {
        padding: 12px;
    }
    
    .amount-highlight {
        font-size: 1.3em;
    }
}

/* Landscape phone orientation */
@media (max-width: 768px) and (orientation: landscape) {
    .balance-container {
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: space-around;
    }

    .balance-tile {
        width: 45%;
        min-width: 200px;
    }

    .transaction-buttons {
        flex-direction: row;
    }

    .tab-button {
        flex: 1;
        margin: 0 5px;
    }
     .balance-container {
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: space-around;
    }

    .balance-tile {
        width: 45%;
        min-width: 180px; /* Reduced to fit more tiles */
        margin: 10px 2.5%;
    }

    /* If there are 3+ tiles (loan + receivable + others), use smaller tiles */
    .balance-container:has(.loan):has(.receivable) .balance-tile {
        width: 30%;
        min-width: 150px;
    }
}

/* Touch-friendly improvements */
@media (hover: none) and (pointer: coarse) {
    /* This targets touch devices */
    button, .tab-button, .balance-tile {
        min-height: 44px; /* Apple's recommended touch target size */
    }

    .tab-button:active {
        background-color: #0056b3;
    }

    .balance-tile:active {
        transform: translateY(-2px);
    }

    /* Increase tap targets for form elements */
    input, select, textarea {
        min-height: 44px;
        padding: 12px;
    }
}
@media (max-width: 600px) {
    .budget-tab {
        min-width: 280px;
        padding: 15px;
    }
    
    .budget-header {
        padding: 8px 15px;
    }
    
    .budget-header h2 {
        font-size: 1.1em;
    }
    
    .budget-values {
        flex-direction: column;
        text-align: center;
        gap: 5px;
    }
    
    .budget-label {
        font-size: 0.9em;
    }
    
    .expense-amount, .remaining-amount {
        font-size: 1em;
        padding: 6px 10px;
    }
    
    .progress-text {
        font-size: 0.8em;
    }
}
@keyframes slideDown {
    from {
        max-height: 0;
        opacity: 0;
    }
    to {
        max-height: 400px;
        opacity: 1;
    }
}

@keyframes slideUp {
    from {
        max-height: 400px;
        opacity: 1;
    }
    to {
        max-height: 0;
        opacity: 0;
    }
}
</style>
<script type="application/json" id="bank-account-data">
    {
        {% for bank_name in bank_accounts|map(attribute='bank_name')|unique %}
        "{{ bank_name }}": [
            {% for bank in bank_accounts if bank.bank_name == bank_name %}
            {% if not loop.first %},{% endif %}
            {
                "number": "{{ bank.account_number }}",
                "display": "{{ bank.account_number }}",
                "balance": {{ bank.balance }}
            }
            {% endfor %}
        ]{% if not loop.last %},{% endif %}
        {% endfor %}
    }
    </script>
    
    <script type="application/json" id="mfs-account-data">
    {
        {% for mfs_name in mfs_accounts|map(attribute='mfs_name')|unique %}
        "{{ mfs_name }}": [
            {% for mfs in mfs_accounts if mfs.mfs_name == mfs_name %}
            {% if not loop.first %},{% endif %}
            {
                "number": "{{ mfs.account_no }}",
                "display": "{{ mfs.account_no }}",
                "balance": {{ mfs.balance }}
            }
            {% endfor %}
        ]{% if not loop.last %},{% endif %}
        {% endfor %}
    }
    </script>
    
    <script>
        // Initialize global account data object once
        window.ACCOUNT_DATA = {
            bankAccounts: {},
            mfsAccounts: {}
        };
    
        // Function to toggle account fields based on selection
        function toggleFields(accountTypeId, bankFieldsId, mfsFieldsId) {
            const accountType = document.getElementById(accountTypeId).value;
            const bankFields = document.getElementById(bankFieldsId);
            const mfsFields = document.getElementById(mfsFieldsId);
    
            if (accountType === 'bank') {
                bankFields.classList.remove('hidden');
                mfsFields.classList.add('hidden');
            } else if (accountType === 'mfs') {
                bankFields.classList.add('hidden');
                mfsFields.classList.remove('hidden');
            } else {
                bankFields.classList.add('hidden');
                mfsFields.classList.add('hidden');
            }
        }
    
        // Function to switch between transaction forms
        function showForm(formType) {
            // Hide all forms
            document.querySelectorAll('.transaction-form').forEach(form => {
                form.classList.add('hidden');
            });
    
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
    
            // Show selected form and activate button
            document.getElementById(`${formType}-form`).classList.remove('hidden');
            document.querySelector(`button[onclick="showForm('${formType}')"]`).classList.add('active');
        }
    
        // Function to show loan modal for any expense
        function showLoanModal(accountType, amount, category, date, description, insufficientFunds = false, accountBalance = 0) {
            // Populate the loan modal with expense details
            document.getElementById('loan_expense_account_type').value = accountType;
            document.getElementById('loan_expense_amount').value = amount;
            document.getElementById('loan_expense_category').value = category;
            document.getElementById('loan_expense_date').value = date;
            document.getElementById('loan_expense_description').value = description || '';
    
            // Set account-specific details
            if (accountType === 'bank') {
                document.getElementById('loan_bank_name').value = document.querySelector('select[name="bank_name"]').value;
                document.getElementById('loan_bank_acc_no').value = document.querySelector('select[name="bank_acc_no"]').value;
            } else if (accountType === 'mfs') {
                document.getElementById('loan_mfs_name').value = document.querySelector('select[name="mfs_name"]').value;
                document.getElementById('loan_mfs_acc_no').value = document.querySelector('select[name="mfs_acc_no"]').value;
            }
    
            // Calculate the minimum loan amount needed
            let minimumLoanAmount;
            if (insufficientFunds && accountBalance > 0) {
                // If user has partial balance, they only need to borrow the difference
                minimumLoanAmount = Math.max(amount - accountBalance, 0);
                console.log(`Calculating minimum loan: ${amount} - ${accountBalance} = ${minimumLoanAmount}`);
            } else {
                // For direct loan option or zero balance, use the full amount
                minimumLoanAmount = amount;
                console.log(`Using full amount as minimum loan: ${minimumLoanAmount}`);
            }
    
            // Set minimum loan amount to the calculated minimum
            document.getElementById('loan_amount').min = minimumLoanAmount.toFixed(2);
            document.getElementById('loan_amount').value = minimumLoanAmount.toFixed(2);
    
            // Default return date to 30 days from now
            const returnDate = new Date();
            returnDate.setDate(returnDate.getDate() + 30);
            document.getElementById('return_date').value = returnDate.toISOString().split('T')[0];
    
            // Update modal title/text based on whether this is for insufficient funds
            if (insufficientFunds) {
                document.querySelector('#loanModal .modal-header h3').textContent = 'Insufficient Funds';
                document.querySelector('#loanModal .modal-body p:first-child').textContent = 
                    'You don\'t have enough balance in the selected account.';
                document.querySelector('#loanModal .modal-body p:nth-child(2)').textContent = 
                    `You need to borrow at least ${minimumLoanAmount.toFixed(2)}/= to complete this expense.`;
            } else {
                document.querySelector('#loanModal .modal-header h3').textContent = 'Record Expense as Loan';
                document.querySelector('#loanModal .modal-body p:first-child').textContent = 
                    'You are recording this expense as a loan.';
                document.querySelector('#loanModal .modal-body p:nth-child(2)').textContent = 
                    'Please enter the loan details below:';
            }
    
            // Add a notice about extra loan amount
            const loanAmountInput = document.getElementById('loan_amount');
            const extraAmountInfo = document.createElement('div');
            extraAmountInfo.id = 'extra-amount-info';
            extraAmountInfo.style.marginTop = '5px';
            extraAmountInfo.style.fontSize = '0.9em';
            extraAmountInfo.style.color = '#28a745';
            extraAmountInfo.textContent = 'Any amount above the required loan will be added to your account balance.';
            
            // Insert the notice after the loan amount input
            if (!document.getElementById('extra-amount-info')) {
                loanAmountInput.parentNode.appendChild(extraAmountInfo);
            }
            
            // Add event listener to update extra amount message as user changes loan amount
            loanAmountInput.addEventListener('input', function() {
                const expenseAmount = parseFloat(document.getElementById('loan_expense_amount').value);
                const loanAmount = parseFloat(this.value);
                const extraAmount = Math.max(loanAmount - minimumLoanAmount, 0);
                
                if (extraAmount > 0) {
                    extraAmountInfo.textContent = `${extraAmount.toFixed(2)}/= will be added to your account balance.`;
                    extraAmountInfo.style.color = '#28a745';
                    extraAmountInfo.style.fontWeight = 'bold';
                } else {
                    extraAmountInfo.textContent = 'Any amount above the required loan will be added to your account balance.';
                    extraAmountInfo.style.fontWeight = 'normal';
                    extraAmountInfo.style.color = '#6c757d';
                }
            });
    
            // Display the modal
            document.getElementById('loanModal').style.display = 'block';
        }

    
        // Universal function to update account numbers for both bank and MFS
        function updateAccountNumbers(selectElement, accountType) {
            const name = selectElement.value;
            if (!name) {
                console.warn(`No ${accountType} name selected`);
                return;
            }
            
            console.log(`Updating ${accountType} accounts for: ${name}`);
            
            // Get the form containing this select
            const form = selectElement.closest('form') || selectElement.closest('.modal-content');
            if (!form) {
                console.error('Could not find parent form for', selectElement);
                return;
            }
            
            // Find the corresponding account number select
            let accNoSelect;
            const selectName = selectElement.name;
            
            // Determine which account number field to update
            if (accountType === 'bank') {
                if (selectName === 'bank_name') {
                    accNoSelect = form.querySelector('select[name="bank_acc_no"]');
                } else if (selectName === 'sender_bank_name') {
                    accNoSelect = form.querySelector('select[name="sender_bank_acc_no"]');
                } else if (selectName === 'receiver_bank_name') {
                    accNoSelect = form.querySelector('select[name="receiver_bank_acc_no"]');
                }
            } else if (accountType === 'mfs') {
                if (selectName === 'mfs_name') {
                    accNoSelect = form.querySelector('select[name="mfs_acc_no"]');
                } else if (selectName === 'sender_mfs_name') {
                    accNoSelect = form.querySelector('select[name="sender_mfs_acc_no"]');
                } else if (selectName === 'receiver_mfs_name') {
                    accNoSelect = form.querySelector('select[name="receiver_mfs_acc_no"]');
                }
            }
            
            if (!accNoSelect) {
                console.error(`Could not find account number select for ${accountType} in form:`, form);
                return;
            }
            
            console.log(`Found account number select:`, accNoSelect.name || accNoSelect.id);
            
            // Clear existing options
            while (accNoSelect.options.length > 0) {
                accNoSelect.remove(0);
            }
            
            // Add new options based on selected account
            const accountData = accountType === 'bank' 
                ? window.ACCOUNT_DATA.bankAccounts[name] 
                : window.ACCOUNT_DATA.mfsAccounts[name];
                    
            if (accountData && accountData.length > 0) {
                accountData.forEach(acc => {
                    const option = document.createElement('option');
                    option.value = acc.number;
                    option.textContent = acc.display || acc.number;
                    accNoSelect.appendChild(option);
                });
                console.log(`Added ${accountData.length} account options for ${name}`);
            } else {
                console.warn(`No accounts found for ${accountType}: ${name}`);
            }
            
            // Re-initialize Select2 if it exists
            if (typeof $ !== 'undefined' && $.fn.select2) {
                try {
                    $(accNoSelect).select2('destroy').select2({
                        width: '100%',
                        dropdownCssClass: 'select2-dropdown'
                    });
                } catch (e) {
                    console.warn('Error reinitializing Select2:', e);
                }
            }
        }
    
        // Enhanced insufficient funds message for transfers
        function showInsufficientFundsMessage(accountType, amount, accountBalance) {
            // Format numbers for better display
            const formattedAmount = amount.toFixed(2);
            const formattedBalance = accountBalance.toFixed(2);
            const missing = (amount - accountBalance).toFixed(2);
            
            // Create a detailed message
            let message = `Insufficient funds for this transfer.\n\n`;
            message += `Required Amount: ${formattedAmount}/=\n`;
            message += `Available Balance: ${formattedBalance}/=\n`;
            message += `Shortage: ${missing}/=\n\n`;
            message += `Please add funds to your account before trying again.`;
            
            alert(message);
        }
        // Add this function with your other budget functions
function skipBudget() {
    if (confirm('Are you sure you want to skip setting a budget?\n\nYou can always set it later, but having a budget helps track your spending better.')) {
        // Set a flag to remember user skipped budget (optional)
        localStorage.setItem('budgetSkipped', 'true');
        localStorage.setItem('budgetSkippedDate', new Date().toISOString());
        closeBudgetModal();
    }
}
    
        // Function to show receivable modal for any expense
        function showReceivableModal(accountType, amount, category, date, description) {
            // Populate the hidden form fields with expense details
            document.getElementById('receivable_account_type').value = accountType;

            // Set account-specific details
            if (accountType === 'bank') {
                document.getElementById('receivable_bank_name').value = document.querySelector('select[name="bank_name"]').value;
                document.getElementById('receivable_bank_acc_no').value = document.querySelector('select[name="bank_acc_no"]').value;
            } else if (accountType === 'mfs') {
                document.getElementById('receivable_mfs_name').value = document.querySelector('select[name="mfs_name"]').value;
                document.getElementById('receivable_mfs_acc_no').value = document.querySelector('select[name="mfs_acc_no"]').value;
            }

            // Set default receivable amount to the expense amount
            document.getElementById('receivable_amount').value = amount.toFixed(2);

            // Default expected return date to 30 days from now
            const returnDate = new Date();
            returnDate.setDate(returnDate.getDate() + 30);
            document.getElementById('expected_return_date').value = returnDate.toISOString().split('T')[0];

            // Clear the notes field
            document.getElementById('receivable_notes').value = '';
            
            // Clear debtor name field
            document.getElementById('debtor_name').value = '';
            
            // Set default interest rate to 0
            document.getElementById('interest_rate').value = '0';

            // Display the modal
            document.getElementById('receivableModal').style.display = 'block';
        }
        function showBudgetModal() {
    document.getElementById('budgetModal').style.display = 'block';
    
    // Focus on the budget amount input
    setTimeout(() => {
        document.getElementById('budget_amount').focus();
    }, 100);
}

function closeBudgetModal() {
    document.getElementById('budgetModal').style.display = 'none';
}

function setBudgetAmount(amount) {
    document.getElementById('budget_amount').value = amount;
}
function toggleBudgetDetails() {
    const budgetDetails = document.getElementById('budgetDetails');
    const budgetSummary = document.querySelector('.budget-summary');
    const toggleIcon = document.getElementById('budgetToggleIcon');
    
    if (budgetDetails) {
        if (budgetDetails.classList.contains('expanded')) {
            // Collapse both sections
            budgetDetails.classList.remove('expanded');
            budgetSummary.classList.remove('expanded');
            toggleIcon.classList.remove('rotated');
            localStorage.setItem('budgetExpanded', 'false');
        } else {
            // Expand both sections
            budgetDetails.classList.add('expanded');
            budgetSummary.classList.add('expanded');
            toggleIcon.classList.add('rotated');
            localStorage.setItem('budgetExpanded', 'true');
        }
    }
}


// Savings notification functions
function checkSavingsNotifications() {
    fetch('/check_savings_notifications')
        .then(response => response.json())
        .then(data => {
            if (data.count > 0) {
                showSavingsNotifications(data.notifications);
            }
        })
        .catch(error => {
            console.error('Error checking savings notifications:', error);
        });
}

function showSavingsNotifications(notifications) {
    const modal = document.getElementById('savingsNotificationModal');
    const content = document.getElementById('savingsNotificationContent');
    
    if (notifications.length === 0) {
        content.innerHTML = `
            <div class="no-notifications">
                <i class="fas fa-check-circle"></i>
                <h3>All Caught Up!</h3>
                <p>No savings reminders for today.</p>
            </div>
        `;
    } else {
        let notificationHTML = `
            <div style="margin-bottom: 20px;">
                <p><strong>üéØ Time to save!</strong> You have ${notifications.length} savings scheme(s) ready for contribution:</p>
            </div>
        `;
        
        notifications.forEach(notification => {
            const progress = (notification.current_amount / notification.target_amount * 100).toFixed(1);
            
            // Set urgency styling and message
            let urgencyClass = '';
            let urgencyMessage = '';
            let urgencyIcon = 'üìÖ';
            
            switch(notification.urgency) {
                case 'today':
                    urgencyClass = 'urgency-today';
                    urgencyMessage = 'Reminder day is today!';
                    urgencyIcon = 'üÜï';
                    break;
                case 'recent':
                    urgencyClass = 'urgency-recent';
                    urgencyMessage = `${notification.days_since_notification} days since reminder day`;
                    urgencyIcon = '‚è∞';
                    break;
                case 'overdue':
                    urgencyClass = 'urgency-overdue';
                    urgencyMessage = `${notification.days_since_notification} days overdue!`;
                    urgencyIcon = '‚ö†Ô∏è';
                    break;
                case 'critical':
                    urgencyClass = 'urgency-critical';
                    urgencyMessage = `${notification.days_since_notification} days overdue! Please contribute soon.`;
                    urgencyIcon = 'üö®';
                    break;
            }
            
            notificationHTML += `
                <div class="notification-scheme ${urgencyClass}">
                    <div class="notification-scheme-header">
                        <h3 class="scheme-title">${notification.scheme_name}</h3>
                        <div class="notification-day-badge">Day ${notification.notification_day}</div>
                    </div>
                    
                    <div class="urgency-indicator">
                        <span class="urgency-icon">${urgencyIcon}</span>
                        <span class="urgency-message">${urgencyMessage}</span>
                    </div>
                    
                    <div class="notification-progress">
                        <div class="progress-info">
                            <span>Progress: ${progress}%</span>
                            <span>${notification.current_amount.toFixed(2)}/= of ${notification.target_amount.toFixed(2)}/=</span>
                        </div>
                        <div class="notification-progress-bar">
                            <div class="notification-progress-fill" style="width: ${Math.min(progress, 100)}%"></div>
                        </div>
                    </div>
                    
                    <div class="suggested-amount">
                        <h4><i class="fas fa-lightbulb"></i> Suggested Monthly Contribution:</h4>
                        <div class="amount-highlight">${notification.suggested_amount.toFixed(2)}/=</div>
                        <small>Based on your remaining target and time</small>
                    </div>
                    
                    <div class="notification-actions">
                        <a href="/savings_scheme_details/${notification.scheme_id}" class="notification-btn btn-contribute">
                            <i class="fas fa-plus-circle"></i> Add Contribution
                        </a>
                        <button onclick="changeNotificationDay(${notification.scheme_id}, ${notification.notification_day})" class="notification-btn btn-change-day">
                            <i class="fas fa-calendar-edit"></i> Change Reminder Day
                        </button>
                        <button onclick="dismissNotification(${notification.scheme_id})" class="notification-btn btn-dismiss">
                            <i class="fas fa-times"></i> Dismiss for Today
                        </button>
                    </div>
                </div>
            `;
        });
        
        content.innerHTML = notificationHTML;
    }
    
    modal.style.display = 'block';
}


function closeSavingsNotification() {
    document.getElementById('savingsNotificationModal').style.display = 'none';
}

function dismissNotification(schemeId) {
    fetch(`/dismiss_savings_notification/${schemeId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeSavingsNotification();
            // Show a brief confirmation
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 1001;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            notification.innerHTML = '<i class="fas fa-check"></i> Reminder dismissed for today';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 3000);
        }
    })
    .catch(error => {
        console.error('Error dismissing notification:', error);
    });
}

let currentSchemeId = null;

function changeNotificationDay(schemeId, currentDay) {
    currentSchemeId = schemeId;
    document.getElementById('new_notification_day').value = currentDay;
    document.getElementById('updateNotificationModal').style.display = 'block';
}

function closeUpdateNotificationModal() {
    document.getElementById('updateNotificationModal').style.display = 'none';
    currentSchemeId = null;
}







        // Main initialization when DOM is loaded
        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOM loaded, initializing app...');
                const budgetDetails = document.getElementById('budgetDetails');
                const toggleIcon = document.getElementById('budgetToggleIcon');
                const wasExpanded = localStorage.getItem('budgetExpanded') === 'true';
                
                if (budgetDetails && wasExpanded) {
                    budgetDetails.classList.add('expanded');
                    if (toggleIcon) {
                        toggleIcon.classList.add('rotated');
                    }
                }

                {% if not budget %}
                // Show budget modal automatically on every login when no budget is set
                setTimeout(() => {
                    console.log('No budget set, showing budget modal...');
                    showBudgetModal();
                    
                    // Add a welcome message to the modal for first-time users
                    const modalBody = document.querySelector('#budgetModal .modal-body p');
                    if (modalBody) {
                        modalBody.innerHTML = `
                            <strong>Welcome!</strong> To get started with budget tracking, please set your monthly budget for {{ month_name }} {{ current_year }}.
                            <br><br>
                            This will help you track your spending and manage your finances better.
                        `;
                    }
                    
                    // Make the modal persistent (harder to dismiss accidentally)
                    const budgetModal = document.getElementById('budgetModal');
                    
                    // Prevent closing by clicking outside
                    budgetModal.addEventListener('click', function(e) {
                        if (e.target === budgetModal) {
                            // Show a gentle reminder instead of closing
                            alert('Please set your monthly budget to continue. This helps track your spending effectively.');
                            return false;
                        }
                    });
                    
                    // Modify the close button to show confirmation
                    const closeButton = budgetModal.querySelector('.close-modal');
                    if (closeButton) {
                        closeButton.addEventListener('click', function(e) {
                            if (confirm('Are you sure you want to skip setting a budget? You can always set it later from the dashboard.')) {
                                closeBudgetModal();
                            } else {
                                e.preventDefault();
                                return false;
                            }
                        });
                    }
                    
                }, 500); // Reduced delay to 500ms for faster appearance
                {% endif %}
                
                // Parse JSON data from hidden elements
                try {
                    const bankAccountJson = document.getElementById('bank-account-data').textContent.trim();
                    const mfsAccountJson = document.getElementById('mfs-account-data').textContent.trim();
        
                    window.ACCOUNT_DATA.bankAccounts = JSON.parse(bankAccountJson);
                    window.ACCOUNT_DATA.mfsAccounts = JSON.parse(mfsAccountJson);
                    
                    console.log('Bank accounts loaded:', Object.keys(window.ACCOUNT_DATA.bankAccounts).length);
                    console.log('MFS accounts loaded:', Object.keys(window.ACCOUNT_DATA.mfsAccounts).length);
                    
                    // Debug: Log the accounts for each bank/MFS
                    Object.keys(window.ACCOUNT_DATA.bankAccounts).forEach(bank => {
                        console.log(`Bank ${bank} has accounts:`, window.ACCOUNT_DATA.bankAccounts[bank].map(acc => acc.number));
                    });
                    
                    Object.keys(window.ACCOUNT_DATA.mfsAccounts).forEach(mfs => {
                        console.log(`MFS ${mfs} has accounts:`, window.ACCOUNT_DATA.mfsAccounts[mfs].map(acc => acc.number));
                    });
                } catch (e) {
                    console.error("Error parsing account data:", e);
                    console.error("Bank data:", document.getElementById('bank-account-data').textContent);
                    console.error("MFS data:", document.getElementById('mfs-account-data').textContent);
                }
        
                // Show expense form by default when page loads
                showForm('expense');
    
            // Set up loan modal functionality
            const loanModal = document.getElementById('loanModal');
            const loanModalClose = document.getElementById('loanModalClose');
            const cancelLoanButton = document.getElementById('cancelLoanButton');
    
            // Add event listeners to close the loan modal
            if (loanModalClose) {
                loanModalClose.addEventListener('click', function () {
                    loanModal.style.display = 'none';
                });
            }
    
            if (cancelLoanButton) {
                cancelLoanButton.addEventListener('click', function () {
                    loanModal.style.display = 'none';
                });
            }
    
            // Close modals when clicking outside
            window.addEventListener('click', function (e) {
                const budgetModal = document.getElementById('budgetModal');
                if (e.target === budgetModal) {
                    closeBudgetModal();
                }
                if (e.target === loanModal) {
                    loanModal.style.display = 'none';
                }
                if (e.target === receivableModal) {
                    receivableModal.style.display = 'none';
                }
            });
            
            // Set up receivable modal functionality
            const receivableModal = document.getElementById('receivableModal');
            const receivableModalClose = document.getElementById('receivableModalClose');
            const cancelReceivableButton = document.getElementById('cancelReceivableButton');
    
            // Add event listeners to close the receivable modal
            if (receivableModalClose) {
                receivableModalClose.addEventListener('click', function () {
                    receivableModal.style.display = 'none';
                });
            }
    
            if (cancelReceivableButton) {
                cancelReceivableButton.addEventListener('click', function () {
                    receivableModal.style.display = 'none';
                });
            }
    
            // Add validation for loan amount form
            const loanForm = document.getElementById('loanForm');
            if (loanForm) {
                loanForm.addEventListener('submit', function(e) {
                    const expenseAmount = parseFloat(document.getElementById('loan_expense_amount').value);
                    const loanAmount = parseFloat(document.getElementById('loan_amount').value);
                    const minimumRequired = parseFloat(document.getElementById('loan_amount').min);
                    
                    if (loanAmount < minimumRequired) {
                        e.preventDefault();
                        alert(`The loan amount must be at least ${minimumRequired.toFixed(2)}/=.`);
                        return false;
                    }
                    
                    // If loan amount is greater than minimum required, show confirmation with breakdown
                    if (loanAmount > minimumRequired) {
                        const extraAmount = (loanAmount - minimumRequired).toFixed(2);
                        let confirmMessage = `Loan breakdown:\n\n`;
                        
                        if (minimumRequired === expenseAmount) {
                            // Full expense amount borrowed
                            confirmMessage += `- ${minimumRequired.toFixed(2)}/= for the expense\n`;
                        } else {
                            // Partial expense amount borrowed (user had some balance)
                            confirmMessage += `- ${minimumRequired.toFixed(2)}/= to cover the remaining expense\n`;
                        }
                        
                        // Extra amount that will be added to balance
                        confirmMessage += `- ${extraAmount}/= will be added to your account balance\n\n`;
                        confirmMessage += `Total loan: ${loanAmount.toFixed(2)}/=\n\n`;
                        confirmMessage += `Do you want to proceed?`;
                        
                        if (!confirm(confirmMessage)) {
                            e.preventDefault();
                            return false;
                        }
                    }
                    
                    return true;
                });
            }
    
            // Initialize account selects
            // Bank account selects
            document.querySelectorAll('select[name*="bank_name"]').forEach(select => {
                console.log('Initializing bank select:', select.name);
                
                // Add change event listener
                select.addEventListener('change', function() {
                    updateAccountNumbers(this, 'bank');
                });
                
                // Initialize on page load if there's a selected value
                if (select.value) {
                    updateAccountNumbers(select, 'bank');
                }
            });
            
            // MFS account selects
            document.querySelectorAll('select[name*="mfs_name"]').forEach(select => {
                console.log('Initializing MFS select:', select.name);
                
                // Add change event listener
                select.addEventListener('change', function() {
                    updateAccountNumbers(this, 'mfs');
                });
                
                // Initialize on page load if there's a selected value
                if (select.value) {
                    updateAccountNumbers(select, 'mfs');
                }
            });
    
            // Handle expense form submission and insufficient funds check
            const expenseForm = document.querySelector('#expense-form form');
            if (expenseForm) {
                // Add the "Record as Loan" checkbox to the expense form
                const submitButton = expenseForm.querySelector('button[type="submit"]');
                const loanButtonWrapper = document.createElement('div');
                loanButtonWrapper.style.marginBottom = '20px';
                loanButtonWrapper.style.display = 'flex';
                loanButtonWrapper.style.justifyContent = 'space-between';
                loanButtonWrapper.style.alignItems = 'center';
                
                // Create a normal submit button
                const normalSubmitButton = document.createElement('button');
                normalSubmitButton.type = 'button';
                normalSubmitButton.textContent = 'Submit Expense';
                normalSubmitButton.className = 'submit-button';
                normalSubmitButton.style.backgroundColor = '#007bff';
                
                // Create a loan button
                const loanButton = document.createElement('button');
                loanButton.type = 'button';
                loanButton.textContent = 'Record as Loan';
                loanButton.className = 'loan-button';
                loanButton.style.backgroundColor = '#dc3545';
                loanButton.style.marginLeft = '10px';
                
                // Create a receivable button
                const receivableButton = document.createElement('button');
                receivableButton.type = 'button';
                receivableButton.textContent = 'Record as Receivable';
                receivableButton.className = 'receivable-button';
                receivableButton.style.backgroundColor = '#28a745';
                receivableButton.style.marginLeft = '10px';
                
                // Replace the original submit button with these three options
                loanButtonWrapper.appendChild(normalSubmitButton);
                loanButtonWrapper.appendChild(loanButton);
                loanButtonWrapper.appendChild(receivableButton);
                submitButton.parentNode.replaceChild(loanButtonWrapper, submitButton);
                
                // Add event listener for normal submission
                normalSubmitButton.addEventListener('click', function() {
                    handleExpenseSubmission(false);
                });
                
                // Add event listener for loan submission
                loanButton.addEventListener('click', function() {
                    handleExpenseSubmission(true);
                });
                
                // Add event listener for receivable submission
                receivableButton.addEventListener('click', function() {
                    handleExpenseSubmission(false, true); // false for isLoan, true for isReceivable
                });
                
                // Function to handle expense submission
                function handleExpenseSubmission(asLoan, asReceivable) {
                    const accountType = document.getElementById('expense_account_type').value;
                    const amount = parseFloat(document.getElementById('expense_amount').value);
                    const category = document.getElementById('expense_category').value;
                    const date = document.getElementById('expense_date').value;
                    const description = document.getElementById('expense_description') ? document.getElementById('expense_description').value : '';
                    
                    // If recording as loan, show loan modal regardless of balance
                    if (asLoan) {
                        showLoanModal(accountType, amount, category, date, description, false);
                        return;
                    }
                    
                    // If recording as receivable, show receivable modal regardless of balance
                    if (asReceivable) {
                        showReceivableModal(accountType, amount, category, date, description);
                        return;
                    }
                    
                    // Otherwise, check for sufficient balance
                    let hasEnoughBalance = true;
                    let accountBalance = 0;
    
                    if (accountType === 'wallet') {
                        accountBalance = parseFloat('{{ wallet_balance }}');
                        hasEnoughBalance = accountBalance >= amount;
                    } else if (accountType === 'bank') {
                        const bankName = document.querySelector('select[name="bank_name"]').value;
                        const bankAccNo = document.querySelector('select[name="bank_acc_no"]').value;
    
                        // Find the bank account's balance from our data object
                        if (window.ACCOUNT_DATA.bankAccounts[bankName]) {
                            const account = window.ACCOUNT_DATA.bankAccounts[bankName].find(acc => acc.number === bankAccNo);
                            if (account) {
                                accountBalance = parseFloat(account.balance);
                                hasEnoughBalance = accountBalance >= amount;
                            }
                        }
                    } else if (accountType === 'mfs') {
                        const mfsName = document.querySelector('select[name="mfs_name"]').value;
                        const mfsAccNo = document.querySelector('select[name="mfs_acc_no"]').value;
    
                        // Find the MFS account's balance from our data object
                        if (window.ACCOUNT_DATA.mfsAccounts[mfsName]) {
                            const account = window.ACCOUNT_DATA.mfsAccounts[mfsName].find(acc => acc.number === mfsAccNo);
                            if (account) {
                                accountBalance = parseFloat(account.balance);
                                hasEnoughBalance = accountBalance >= amount;
                            }
                        }
                    }
    
                    console.log(`Expense - Account type: ${accountType}, Amount: ${amount}, Balance: ${accountBalance}, Sufficient: ${hasEnoughBalance}`);
    
                    if (hasEnoughBalance) {
                        // If there's enough balance, submit the form normally
                        expenseForm.submit();
                    } else {
                        // First show an insufficient balance alert with option to proceed
                        const formattedAmount = amount.toFixed(2);
                        const formattedBalance = accountBalance.toFixed(2);
                        const missing = (amount - accountBalance).toFixed(2);
                        
                        // Create a detailed message about insufficient funds
                        const message = `Insufficient funds for this expense.\n\n` +
                            `Required Amount: ${formattedAmount}/=\n` +
                            `Available Balance: ${formattedBalance}/=\n` +
                            `Shortage: ${missing}/=\n\n` +
                            `Would you like to record this as a loan?`;
                        
                        if (confirm(message)) {
                            // If user confirms, show the loan modal with the insufficient funds context
                            // Pass the account balance so we can calculate the minimum loan needed
                            showLoanModal(accountType, amount, category, date, description, true, accountBalance);
                        }
                        // If user cancels, do nothing (stay on form)
                    }
                }
            }
    
            // Handle transfer form submission and check for insufficient funds
            const transferForm = document.querySelector('#transfer-form form');
            if (transferForm) {
                transferForm.addEventListener('submit', function (e) {
                    e.preventDefault();
    
                    const senderAccountType = document.getElementById('sender_account_type').value;
                    const amount = parseFloat(document.getElementById('transfer_amount').value);
    
                    // Check if the sender has sufficient balance
                    let hasEnoughBalance = true;
                    let accountBalance = 0;
    
                    if (senderAccountType === 'wallet') {
                        accountBalance = parseFloat('{{ wallet_balance }}');
                        hasEnoughBalance = accountBalance >= amount;
                    } else if (senderAccountType === 'bank') {
                        const bankName = document.querySelector('select[name="sender_bank_name"]').value;
                        const bankAccNo = document.querySelector('select[name="sender_bank_acc_no"]').value;
    
                        // Find the bank account's balance from our data object
                        if (window.ACCOUNT_DATA.bankAccounts[bankName]) {
                            const account = window.ACCOUNT_DATA.bankAccounts[bankName].find(acc => acc.number === bankAccNo);
                            if (account) {
                                accountBalance = parseFloat(account.balance);
                                hasEnoughBalance = accountBalance >= amount;
                            }
                        }
                    } else if (senderAccountType === 'mfs') {
                        const mfsName = document.querySelector('select[name="sender_mfs_name"]').value;
                        const mfsAccNo = document.querySelector('select[name="sender_mfs_acc_no"]').value;
    
                        // Find the MFS account's balance from our data object
                        if (window.ACCOUNT_DATA.mfsAccounts[mfsName]) {
                            const account = window.ACCOUNT_DATA.mfsAccounts[mfsName].find(acc => acc.number === mfsAccNo);
                            if (account) {
                                accountBalance = parseFloat(account.balance);
                                hasEnoughBalance = accountBalance >= amount;
                            }
                        }
                    }
    
                    console.log(`Transfer - Account type: ${senderAccountType}, Amount: ${amount}, Balance: ${accountBalance}, Sufficient: ${hasEnoughBalance}`);
    
                    if (hasEnoughBalance) {
                        // If there's enough balance, submit the form normally
                        this.submit();
                    } else {
                        // For transfers, show an enhanced error message
                        showInsufficientFundsMessage(senderAccountType, amount, accountBalance);
                    }
                });
            }
    
            // Initialize Select2 for better dropdown UX if jQuery is available
            if (typeof $ !== 'undefined' && $.fn.select2) {
                // Initialize Select2 on all selects 
                $('select').select2({
                    width: '100%',
                    dropdownCssClass: 'select2-dropdown'
                });
                
                // Add special event handlers for Select2 changes
                $('select[name*="bank_name"]').on('select2:select', function() {
                    updateAccountNumbers(this, 'bank');
                });
                
                $('select[name*="mfs_name"]').on('select2:select', function() {
                    updateAccountNumbers(this, 'mfs');
                });
            }
            // Handle update notification form submission
document.getElementById('updateNotificationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!currentSchemeId) return;
    
    const newDay = document.getElementById('new_notification_day').value;
    
    fetch(`/update_notification_day/${currentSchemeId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            notification_day: newDay
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeUpdateNotificationModal();
            closeSavingsNotification();
            
            // Show success message
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #007bff;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 1001;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            notification.innerHTML = `<i class="fas fa-calendar-check"></i> ${data.message}`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 3000);
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error updating notification day:', error);
        alert('Error updating notification day');
    });
});

// Update your existing DOMContentLoaded function to include savings notifications
// Add this to your existing DOMContentLoaded event listener:

// Check for savings notifications after a short delay
setTimeout(() => {
    checkSavingsNotifications();
}, 1500); // Check after budget modal logic

// Close notification modals when clicking outside
window.addEventListener('click', function(event) {
    const savingsModal = document.getElementById('savingsNotificationModal');
    const updateModal = document.getElementById('updateNotificationModal');
    
    if (event.target === savingsModal) {
        closeSavingsNotification();
    }
    if (event.target === updateModal) {
        closeUpdateNotificationModal();
    }
});
        });
        

    </script>
{% endblock %}